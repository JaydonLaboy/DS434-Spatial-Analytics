---
title: "Spatial Optimization"
format: html
editor: visual
---

## Spatial Optimization Project

Description: Zoning, Rainfall, Soil Type,

1.  Soil type

    1.  Soil type (map it out)

    2.  Find best soil for agriculture (Show on map)

<!-- -->

2.  Water Availability

    1.  Rainfall data/Annual precipitation

<!-- -->

3.  Zoning

To spatially optimize a dryland kalo farm on Oahu, this project will focus specifically on agricultural zoning, rainfall patterns, and soil type to identify the most suitable locations for cultivation.

First, I will map agricultural zoning districts across Oahu to determine where farming activities are legally permitted and prioritized. Areas designated for agriculture will serve as the foundation of the suitability analysis, while non-agricultural or highly restricted zones will be excluded from consideration.

Next, I will analyze rainfall data to evaluate water availability for dryland kalo production. Because dryland kalo relies on natural precipitation rather than irrigated loʻi systems, areas with moderate and consistent rainfall will rank higher in suitability. Rainfall maps will highlight zones that receive sufficient precipitation to sustain crop growth without excessive drought stress.

I will then create a soil type map to identify and classify soils across the island. Particular attention will be given to well-drained, nutrient-rich volcanic soils that are well suited for kalo cultivation. Soil units known to support productive agriculture will receive higher suitability scores, while shallow, rocky, or poorly drained soils will rank lower.

Finally, I will combine agricultural zoning, rainfall, and soil data to identify the most optimal locations for establishing a dryland kalo farm on Oʻahu based on regulatory feasibility, water availability, and soil quality.

(Hawaii climate data portal, geoportal.hawaii.gov, opendata hawaii(?) <https://opendata.hawaii.gov/dataset/watersheds>

```{r}
library(terra)

dem1 <- rast("USGS_13_n22w158_20250611.tif")
dem2 <- rast("USGS_13_n22w159_20250611.tif")
```

```{r}
dem <- mosaic(dem1, dem2)
plot(dem, main="Oahu Elevation (meters)")
```

Satellite map (Elevation is now working, Just need something for slope)

```{r}
library(terra)
library(leaflet)

dem <- mosaic(dem1, dem2)
dem_wgs84 <- project(dem, "EPSG:4326")

# Aggregate to reduce size (factor = 4 means 1/4 resolution)
dem_agg <- aggregate(dem_wgs84, fact = 4, fun = "mean")

# Check size — keep reducing 'fact' until it works
# fact=4 reduces ~16x, fact=6 reduces ~36x

pal <- colorNumeric(
  palette = c("#300060", "#00AACC", "#FFFF00"),
  values(dem_agg),
  na.color = "transparent"
)

leaflet() %>%
  addProviderTiles(providers$Esri.WorldImagery) %>%
  addRasterImage(dem_agg, colors = pal, opacity = 0.6) %>%
  addLegend(pal = pal, values = values(dem_agg),
            title = "Elevation (m)", position = "bottomright")
```

Rainfall: <https://www.hawaii.edu/climate-data-portal/data-portal/>

```{r}
library(terra)
library(leaflet)

# Load all files from 2020-2026
all_files <- list.files("data_map", 
                         pattern = "\\.tif$", 
                         full.names = TRUE, 
                         recursive = TRUE)

# Filter to only 2020-2026
files_2020_2026 <- all_files[grepl("/(202[0-6])/", all_files)]
cat("Files found:", length(files_2020_2026), "\n")

# Stack and compute mean
rain_stack      <- rast(files_2020_2026)
rain_mean       <- app(rain_stack, mean, na.rm = TRUE)
rain_mean_wgs84 <- project(rain_mean, "EPSG:4326")

# All blue, no white
pal <- colorNumeric(
  palette = c("#4A90D9", "#1A5276", "#0B2545"),
  values(rain_mean_wgs84),
  na.color = "transparent"
)

# Interactive map
leaflet() %>%
  addProviderTiles(providers$Esri.WorldImagery) %>%
  addRasterImage(rain_mean_wgs84, 
                 colors  = pal, 
                 opacity = 0.7,
                 maxBytes = 20 * 1024 * 1024) %>%
  addLegend(pal      = pal, 
            values   = values(rain_mean_wgs84),
            title    = "Avg Monthly<br>Rainfall (mm)", 
            position = "bottomright") %>%
  addControl("<b>Average Monthly Rainfall 2020–2026</b>", 
             position = "topright")
```

Zoning:

```{r}
library(sf)
library(here)
library(dplyr)
library(mapview)

zoning <- st_read(here("Zoning.geojson"), quiet = TRUE)

ag2_land <- zoning |>
  filter(zone_class == "AG-2") |>
  st_make_valid()

mapview(ag2_land,
        col.regions = "goldenrod",
        alpha.regions = 0.4,
        layer.name = "AG-2 General Agriculture")
```

Rainfall + Agricultural Zoning

```{r}
library(terra)
library(leaflet)
library(sf)
library(here)
library(dplyr)

# --- Rainfall ---
all_files <- list.files("data_map", 
                         pattern = "\\.tif$", 
                         full.names = TRUE, 
                         recursive = TRUE)

files_2020_2026 <- all_files[grepl("/(202[0-6])/", all_files)]

rain_stack      <- rast(files_2020_2026)
rain_mean       <- app(rain_stack, mean, na.rm = TRUE)
rain_mean_wgs84 <- project(rain_mean, "EPSG:4326")

# --- AG-2 Zones ---
zoning <- st_read(here("Zoning.geojson"), quiet = TRUE)

ag2_land <- zoning |>
  filter(zone_class == "AG-2") |>
  st_make_valid() |>
  st_transform(crs = 4326)  # make sure CRS matches rainfall

# --- Mask rainfall to AG-2 only ---
ag2_vect        <- vect(ag2_land)                        # convert to terra format
rain_masked     <- mask(rain_mean_wgs84, ag2_vect)       # mask to AG-2 boundary
rain_cropped    <- crop(rain_masked, ag2_vect)           # crop extent too

# --- Color palette ---
pal <- colorNumeric(
  palette  = c("#4A90D9", "#1A5276", "#0B2545"),
  values(rain_cropped),
  na.color = "transparent"
)

# --- Map ---
leaflet() %>%
  addProviderTiles(providers$Esri.WorldImagery) %>%
  addPolygons(data        = ag2_land,
              fillColor   = "transparent",
              color       = "goldenrod",
              weight      = 1.5,
              opacity     = 0.9,
              group       = "AG-2 Boundary") %>%
  addRasterImage(rain_cropped,
                 colors   = pal,
                 opacity  = 0.75,
                 maxBytes = 20 * 1024 * 1024) %>%
  addLegend(pal      = pal,
            values   = values(rain_cropped),
            title    = "Avg Monthly<br>Rainfall (mm)",
            position = "bottomright") %>%
  addControl("<b>Average Monthly Rainfall 2020–2026<br>AG-2 Zones Only</b>",
             position = "topright") %>%
  addLayersControl(overlayGroups = "AG-2 Boundary")
```

Soil Data

```{r}
library(sf)
library(leaflet)
library(dplyr)

# Read soil data
soils <- st_read("hawaii_soils_with_orders.geojson", quiet = TRUE)

# Check what columns are available
names(soils)
unique(soils$order)  # adjust column name if different
```

```{r}
library(sf)
library(leaflet)
library(dplyr)

# Read soil data
soils <- st_read("hawaii_soils_with_orders.geojson", quiet = TRUE) |>
  st_transform(crs = 4326)

# Color palette by soil order
pal <- colorFactor(
  palette = "Set3",
  domain  = soils$taxorder
)

# Map
leaflet(soils) %>%
  addProviderTiles(providers$Esri.WorldImagery) %>%
  addPolygons(
    fillColor   = ~pal(taxorder),
    fillOpacity = 0.6,
    color       = "white",
    weight      = 0.5,
    label       = ~paste0(taxorder, " - ", compname),
    highlightOptions = highlightOptions(
      weight      = 2,
      color       = "white",
      fillOpacity = 0.9,
      bringToFront = TRUE
    )
  ) %>%
  addLegend(
    pal      = pal,
    values   = ~taxorder,
    title    = "Soil Order",
    position = "bottomright"
  ) %>%
  addControl("<b>Hawaii Soil Orders</b>", position = "topright")
```
